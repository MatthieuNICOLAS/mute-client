/*! mute-client 2014-07-22 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.Mute=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){var c={Coordinator:a("./lib/coordinator"),SocketIOAdapter:a("./lib/socket-io-adapter"),AceEditorAdapter:a("./lib/ace-editor-adapter"),InfosUsersModule:a("./lib/infos-users")};b.exports=c},{"./lib/ace-editor-adapter":2,"./lib/coordinator":3,"./lib/infos-users":4,"./lib/socket-io-adapter":5}],2:[function(a,b){var c=a("events"),d=-1,e=0,f=1,g=function(a,b){var c=this,e=document.createElement("style");this.coordinator=b,this.currentMarkers=[],this.userInfosChanged=!1,this.mousePos=null,this.mode=d,this.flag=!1,this.lastCursorIndex=0,this.previousLine=0,this.userInfosUpdateTimeout=null,Range=ace.require("ace/range").Range,e.type="text/css",e.innerHTML=".editor { margin-left: 15px; margin-top: 15px; width: 1100px; height: 600px; overflow: visible }",document.getElementsByTagName("head")[0].appendChild(e),document.getElementById(a).className="editor",this.editor=ace.edit(a),this.editor.setTheme("ace/theme/dawn"),this.editor.getSession().setTabSize(4),this.editor.getSession().setUseWrapMode(!0),null!==this.coordinator&&this.coordinator.on("initEditor",function(a){c.init(a)}),this.editor.session.on("changeScrollTop",function(){c.emit("scroll",{topRow:c.editor.renderer.getScrollTopRow()})}),this.editor.focus()};g.prototype.__proto__=c.EventEmitter.prototype,g.prototype.setInfosUsersModule=function(a){this.infosUsersModule=a},g.prototype.init=function(a){this.mode!==f&&(this.toHistoryMode(),this.editor.setValue(a.str),this.updateInfosUser(),this.toEditionMode(!0),this.infosUsersModule.updateRemoteInfosUsers())},g.prototype.sendUserInfos=function(){var a,b,c,d,e=this.editor.session.doc,f=[];a=e.positionToIndex(this.editor.getCursorPosition()),b=this.editor.session.getSelection(),null===b||void 0===b||b.isEmpty()||b.inMultiSelectMode||(b.isBackwards()?(c=e.positionToIndex(b.lead),d=e.positionToIndex(b.anchor)):(c=e.positionToIndex(b.anchor),d=e.positionToIndex(b.lead)),f.push({start:c,end:d})),this.emit("changeCursorAndSelections",{infosUser:{cursorIndex:a,selections:f}})},g.prototype.onChangeAdapter=function(a){var b,c,d=a.data,e=this.editor.session.doc.positionToIndex(d.range.start,0),f="";if(this.userInfosChanged=!0,"insertLines"===d.action||"removeLines"===d.action)for(c=d.action.replace("Lines","Text"),b=0;b<d.lines.length;b++)f+=d.lines[b]+"\n";else c=d.action,f=d.text;this.emit("localOperation",{operation:{action:c,index:e,text:f}}),this.infosUsersModule.updateRemoteInfosUsers()},g.prototype.update=function(a){var b=this,c=(this.editor.session.doc,this.editor.renderer.getScrollTopRow()+a.diffNbLines);this.editor.removeAllListeners("change"),this.editor.setValue(a.str),this.updateInfosUser(),this.infosUsersModule.updateRemoteInfosUsers(),this.editor.on("change",function(a){b.onChangeAdapter(a)}),this.editor.renderer.scrollToLine(c,!1,!0)},g.prototype.clearRemoteIndicators=function(){var a;for(a=0;a<this.currentMarkers.length;a++)this.editor.session.removeMarker(this.currentMarkers[a])},g.prototype.addRemoteCursor=function(a,b){var c=this.editor.session.doc.indexToPosition(a),d=new Range(c.row,c.column,c.row,c.column+1);this.currentMarkers.push(this.editor.session.addMarker(d,"",function(a,c,d,e){var f=b.replace("top:FLAG_TOP","top:"+e).replace("left:FLAG_LEFT","left:"+d);return a.push(f)},!0))},g.prototype.addRemoteSelection=function(a,b){var c,d,e,f;for(f=0;f<a.length;f++)c=this.editor.session.doc.indexToPosition(a[f].start),d=this.editor.session.doc.indexToPosition(a[f].end),e=new Range(c.row,c.column,d.row,d.column),this.currentMarkers.push(this.editor.session.addMarker(e,b,"line"))},g.prototype.updateVisibleNames=function(){var a,b,c,d,e=$("[data-remote-cursor=true]");for(a=0;a<e.length;a++)d="#"+e[a].id,b=$(d).attr("data-remote-cursor-row"),c=$(d).attr("data-remote-cursor-column"),$(d).find(".name").hide(),$(d).find(".nubbin").show(),this.mousePos.row==b&&this.mousePos.column==c&&($(d).find(".name").show(),$(d).find(".nubbin").hide())},g.prototype.toHistoryMode=function(){this.mode!==f&&(this.previousLine=parseInt(this.editor.renderer.getScrollTopRow()),this.editor.removeAllListeners("change"),this.editor.removeAllListeners("changeSelection"),this.editor.removeAllListeners("mousemove"),this.coordinator.removeAllListeners("update"),this.editor.setReadOnly(!0),this.emit("readOnlyModeOn"),this.mode=f)},g.prototype.toEditionMode=function(){var a,b=this;this.mode!==e&&(this.editor.on("change",function(a){b.onChangeAdapter(a)}),null!==this.coordinator&&void 0!==this.coordinator&&this.coordinator.on("update",function(a){b.update(a)}),this.editor.on("changeSelection",function(){b.lastCursorIndex=b.editor.session.doc.positionToIndex(b.editor.getCursorPosition()),null===b.userInfosUpdateTimeout&&(b.userInfosUpdateTimeout=setTimeout(function(){b.sendUserInfos(),b.userInfosUpdateTimeout=null},1e3)),b.userInfosChanged=!0}),this.editor.on("mousemove",function(a){b.mousePos=b.editor.renderer.screenToTextCoordinates(a.clientX,a.clientY),b.updateVisibleNames()}),a=this.editor.session.doc.indexToPosition(this.lastCursorIndex,0),this.editor.navigateTo(a.row,a.column),this.editor.scrollToRow(this.previousLine),this.editor.setReadOnly(!1),this.emit("readOnlyModeOff"),this.mode=e,this.editor.focus())},g.prototype.isInHistoryMode=function(){return this.mode===f},g.prototype.isInEditorMode=function(){return this.mode===e},g.prototype.indexToPosition=function(a){return this.editor.session.doc.indexToPosition(a,0)},g.prototype.disable=function(){this.editor.removeAllListeners("change"),this.editor.removeAllListeners("changeSelection"),this.editor.removeAllListeners("mousemove"),this.editor.session.removeAllListeners("changeScrollTop"),this.coordinator.removeAllListeners("update"),this.coordinator.removeAllListeners("initEditor"),this.coordinator=null,this.editor.setReadOnly(!0),this.emit("readOnlyModeOn")},g.prototype.updateInfosUser=function(){var a,b,c,d=this.editor.session.doc,e=this.infosUsersModule.getLocalInfosUser(),f=this.editor.getSelection();for(c=d.indexToPosition(e.cursorIndex,0),this.editor.navigateTo(c.row,c.column),f.ranges=[],f.rangeCount=0,i=0;i<e.selections.length;i++)a=d.indexToPosition(e.selections[i].start),b=d.indexToPosition(e.selections[i].end),f.setSelectionRange(new Range(a.row,a.column,b.row,b.column))},b.exports=g},{events:6}],3:[function(a,b){var c=0,d=1,e=a("mute-utils"),f=a("events"),g=a("mute-structs").LogootSRopes,h=a("mute-structs").TextInsert,j=a("mute-structs").TextDelete,k=a("mute-structs").LogootSAdd,l=a("mute-structs").LogootSDel,m=function(a,b){var d=this;this.docID=a,this.creationDate=new Date,this.history=[],this.lastModificationDate=new Date,this.replicaNumber=-1,this.clock=0,this.ropes=null,this.bufferLocalLogootSOp=[],this.mode=c,this.changed=!1,this.flagDB=!1,this.readOnlyMode=!1,this.bufferLogootSOp=[],this.bufferTextOp=[],this.prevOp=!1,this.prevOpPos=-1,this.posCursor=0,this.viewTopRow=0,this.busy=!1,this.flag=!1,this.network=null,this.editor=null,this.timerTextOp=null,this.serverDB=b,this.updateLastModificationDateTimeout=null,this.localOperationHandler=function(a){var b=a.operation.action,c=a.operation.index,e=a.operation.text;d.addBufferTextOp({action:b,index:c,text:e}),d.updateLastModificationDate((new Date).valueOf())}};m.prototype.__proto__=f.EventEmitter.prototype,m.prototype.init=function(){var a=this,b=function(){a.mode===c&&null!==a.network&&void 0!==a.network?a.emit("initNetwork"):a.join(a)};this.serverDB.models.query().filter("docID",this.docID).execute().done(function(d){var e;0===d.length?(e={docID:a.docID,creationDate:a.creationDate,history:a.history,lastModificationDate:a.lastModificationDate,replicaNumber:a.replicaNumber,clock:a.clock,ropes:a.ropes,bufferLocalLogootSOp:a.bufferLocalLogootSOp,mode:c},a.serverDB.models.add(e).done(function(){b()})):(e=d[0],a.creationDate=e.creationDate,a.history=e.history,a.lastModificationDate=e.lastModificationDate,a.replicaNumber=e.replicaNumber,a.clock=e.clock,a.ropes=e.ropes,a.bufferLocalLogootSOp=e.bufferLocalLogootSOp,a.mode=e.mode,b())}),setInterval(function(){a.changed===!0&&a.updateDoc()},1e3)},m.prototype.setEditor=function(a){var b=this;this.editor=a,this.editor.on("cursor",function(a){b.posCursor=a}),this.editor.on("scroll",function(a){b.viewTopRow=a}),this.editor.on("readOnlyModeOn",function(){console.log("ReadOnlyModeOn"),b.readOnlyMode=!0}),this.editor.on("readOnlyModeOff",function(){console.log("ReadOnlyModeOff"),b.readOnlyMode=!1,b.emit("initEditor",{str:b.ropes.str})})},m.prototype.setNetwork=function(a){var b=this;this.network=a,this.network.on("receiveDoc",function(a){b.join(a)}),this.network.on("receiveOps",function(a){e.pushAll(b.bufferLogootSOp,a.logootSOperations)}),this.network.on("ack",function(a){a.length>0&&(b.bufferLocalLogootSOp=b.bufferLocalLogootSOp.splice(a.length),b.changed=!0)}),this.network.on("connect",function(){b.emit("queryDoc",{docID:b.docID,replicaNumber:b.replicaNumber,bufferLocalLogootSOp:b.bufferLocalLogootSOp})})},m.prototype.addBufferTextOp=function(a){var b=this;this.busy=!0;var c=!1;if(this.prevOp!==a.action&&(c=!0),"insertText"===a.action)this.prevOpPos!==a.index&&(c=!0),c?this.bufferTextOp.push(new h(a.index,a.text)):e.getLast(this.bufferTextOp).content+=a.text,this.prevOpPos=a.index+a.text.length,this.prevOp="insertText";else if("removeText"===a.action){if(!c){c=!0;var d=e.getLast(this.bufferTextOp);"removeText"===this.prevOp&&a.index+a.text.length>=d.offset&&a.index<=d.offset&&(c=!1)}c?this.bufferTextOp.push(new j(a.index,a.text.length)):(d.length+=a.text.length,d.offset=a.index),this.prevOpPos-=a.text.length,this.prevOp="removeText"}else console.error("-- Impossible de convertir les modifications en TextOperations --"),console.error(a);c===!0&&(clearTimeout(this.timerTextOp),this.timerTextOp=setTimeout(function(){console.log("Fin des 1s de buffer, on envoie."),b.busy=!1,b.cleanBufferTextOp(),b.timerTextOp=null},1e3))},m.prototype.cleanBufferTextOp=function(){var a,b,c,d;if(this.bufferTextOp.length>0&&this.flag!==!0){for(this.flag=!0,a=[],b=this.bufferTextOp.length,c=1,this.busy===!1&&(c=0,this.prevOpPos=-1,this.prevOp=!1),c;b>c;c++)d=this.bufferTextOp.shift(),null==d.length||null==d.offset&&0!=d.offset||(d.deletion=this.ropes.str.substr(d.offset,d.length)),this.history.push(d),a.push(d.applyTo(this.ropes));0!==a.length&&(this.changed=!0,e.pushAll(this.bufferLocalLogootSOp,a),this.emit("operations",a)),this.clock=this.ropes.clock,this.flag=!1}},m.prototype.cleanBufferLogootSOp=function(){for(var a,b,c,d,f,g=this,h=[],i=0,j=0;!this.busy&&this.flag!==!0&&0===this.bufferTextOp.length&&this.bufferLogootSOp.length>0;){for(this.flag=!0,i=e.occurrences(this.ropes.str,"\n"),null!==this.editor&&this.editor.removeAllListeners("change"),b=this.bufferLogootSOp.shift(),j=b.owner,c=this.generateLogootSOp(b),d=c.execute(this.ropes),a=0;a<d.length;a++)f=d[a],f.owner=j,null==f.length||null==f.offset&&0!=f.offset||(f.deletion=this.ropes.str.substr(f.offset,f.length)),this.history.push(f),h.push(f),b=this.applyTextOperation(this.ropes.str,f),this.ropes.str=b;i=e.occurrences(this.ropes.str,"\n")-i,this.prevOpPos=-1,this.prevOp=!1,this.flag=!1,this.emit("remoteOperations",{operations:h}),this.emit("update",{str:this.ropes.str,diffNbLines:i}),null!==this.editor&&this.editor.on("change",function(a){g.addBufferTextOp(a),g.updateLastModificationDate((new Date).valueOf())}),g.updateLastModificationDate((new Date).valueOf()),this.emit("updateHistoryScrollerRange",{length:this.history.length}),this.changed=!0}},m.prototype.generateLogootSOp=function(a){if(void 0!==a.id&&void 0!==a.l&&null!==a.id&&null!==a.l){var b=new Identifier(a.id.base,a.id.last);return new k(b,a.l)}if(void 0!==a.lid&&null!==a.lid){var c=[];for(i=0;i<a.lid.length;i++)c.push(new IdentifierInterval(a.lid[i].base,a.lid[i].begin,a.lid[i].end));return new l(c)}},m.prototype.applyTextOperation=function(a,b){return void 0!==b.content&&void 0!==b.offset&&null!==b.content&&null!==b.offset?a=e.insert(a,b.offset,b.content):void 0!==b.length&&null!==b.length&&void 0!==b.offset&&null!==b.offset&&(a=e.del(a,b.offset,b.offset+b.length-1)),a},m.prototype.applyReverseTextOperation=function(a,b){return void 0!==b.content&&void 0!==b.offset&&null!==b.content&&null!==b.offset?a=e.del(a,b.offset,b.offset+b.content.length-1):void 0!==b.length&&null!==b.length&&void 0!==b.offset&&null!==b.offset&&(a=e.insert(a,b.offset,b.deletion)),a},m.prototype.join=function(a){var b,c=this;a.docID=this.docID,this.replicaNumber=a.replicaNumber,c.updateLastModificationDate(new Date(a.lastModificationDate).valueOf()),this.creationDate=a.creationDate,null!==this.editor&&this.editor.removeListener("localOperation",this.localOperationHandler),null!==a.ropes&&void 0!==a.ropes&&(b=new g(this.replicaNumber),b.copyFromJSON(a.ropes),b.clock=this.clock,this.ropes=b),this.history=a.history,e.pushAll(this.bufferLogootSOp,a.bufferLogootSOp),this.readOnlyMode===!1&&(console.log("On envoie"),this.emit("initEditor",{str:this.ropes.str})),this.emit("updateHistoryScrollerRange",{length:this.history.length}),this.emit("updateHistoryScrollerValue",{length:this.history.length}),null!==this.editor&&this.editor.on("localOperation",this.localOperationHandler),setInterval(function(){c.cleanBufferTextOp()},250),setInterval(function(){c.cleanBufferLogootSOp()},250),this.changed=!0},m.prototype.getHistoryLength=function(){return this.history.length},m.prototype.receive=function(a){e.pushAll(this.bufferLogootSOp,a),this.emit("awareness",{nbLogootSOp:this.bufferLogootSOp.length})},m.prototype.updateState=function(a,b,c){var d;if(0===c)return"";if(c>b){if(c<=this.history.length)for(d=b;c>d;d++)a=this.applyTextOperation(a,this.history[d],!1)}else if(b>c&&c>0)for(d=b-1;d>c-1;d--)a=this.applyReverseTextOperation(a,this.history[d],!1);return a},m.prototype.updateDoc=function(){var a,b=this;this.flagDB===!1&&(this.flagDB=!0,this.changed=!1,a={docID:this.docID,creationDate:this.creationDate,history:this.history,lastModificationDate:this.lastModificationDate,replicaNumber:this.replicaNumber,clock:this.clock,ropes:this.ropes,bufferLocalLogootSOp:this.bufferLocalLogootSOp},this.serverDB.models.query().filter("docID",a.docID).modify({replicaNumber:a.replicaNumber,ropes:a.ropes,history:a.history,lastModificationDate:a.lastModificationDate,clock:a.clock,bufferLocalLogootSOp:a.bufferLocalLogootSOp}).execute().done(function(){console.log("MàJé :p"),b.flagDB=!1}))},m.prototype.toOnlineMode=function(){var a=this;this.mode=c,this.serverDB.models.query().filter("docID",this.docID).modify({mode:c}).execute().done(function(){a.emit("initNetwork")})},m.prototype.toOfflineMode=function(){this.mode=d,this.serverDB.models.query().filter("docID",this.docID).modify({mode:d}).execute().done(function(){coordinator.emit("disconnect")})},m.prototype.updateLastModificationDate=function(a){var b=this;this.lastModificationDate=a,null===this.updateLastModificationDateTimeout&&(b.updateLastModificationDateTimeout=setTimeout(function(){b.emit("updateLastModificationDate",{lastModificationDate:b.lastModificationDate}),b.updateLastModificationDateTimeout=null},1e3))},m.prototype.dispose=function(){this.editor.removeAllListeners("localOperation"),this.editor.removeAllListeners("cursor"),this.editor.removeAllListeners("scroll"),this.network.removeAllListeners("collaboratorJoin"),this.network.removeAllListeners("collaboratorLeave"),this.network.removeAllListeners("receiveDoc"),this.network.removeAllListeners("receiveOps"),this.network.removeAllListeners("ack"),this.network.removeAllListeners("connect"),this.network.removeAllListeners("disconnect"),this.network=null,this.editor=null},b.exports=m},{events:6,"mute-structs":7,"mute-utils":23}],4:[function(a,b){var c=a("events"),d=function(a,b,c,d,e,f){var g=this;if(this.docID=a,this.infosUsers={"-1":{cursorIndex:0,selections:[],username:"Unknown user"}},this.replicaNumber=-1,this.updateTimeout=null,this.readOnlyMode=!1,this.offlineMode=!0,this.coordinator=b,b.on("remoteOperations",function(a){var b=a.operations;g.applyRemoteOperations(b)}),this.editor=c,c.on("changeCursorAndSelections",function(a){var b=a.infosUser.cursorIndex,c=a.infosUser.selections;a.replicaNumber=g.replicaNumber,g.offlineMode===!1&&g.emit("changeLocalCursorAndSelections",a),g.updateCursorAndSelections(g.replicaNumber,b,c)}),c.on("localOperation",function(a){var b=a.operation.action,c=a.operation.index,d=a.operation.text;g.applyLocalOperation(b,c,d)}),c.on("readOnlyModeOn",function(){g.readOnlyMode=!0,g.emit("updateRemoteIndicators",{infosUsers:{}})}),c.on("readOnlyModeOff",function(){g.readOnlyMode=!1,g.updateRemoteInfosUsers()}),null!==d&&void 0!==d){this.network=d;var h=function(a){var b,c;g.replicaNumber=a.replicaNumber,delete g.infosUsers[-1];for(b in a.infosUsers)c=a.infosUsers[b],g.infosUsers[b]={cursorIndex:c.cursorIndex,selections:c.selections,username:c.username};g.updateLocalUsername(g.infosUsers[g.replicaNumber].username),g.network.removeListener("receiveDoc",h),g.network.on("receiveDoc",i)},i=function(a){var b,c=g.getLocalInfosUser(),d={};d[g.replicaNumber]={cursorIndex:c.cursorIndex,selections:c.selections,username:c.username};for(b in a.infosUsers)parseInt(b)!==parseInt(g.replicaNumber)&&(c=a.infosUsers[b],d[b]={cursorIndex:c.cursorIndex,selections:c.selections,username:c.username});g.infosUsers=d};d.on("receiveDoc",h),d.on("receiveUserJoin",function(a){var b=a.replicaNumber,c=a.username;g.emit("addCollaborator",a),g.addUser(b,c),g.updateRemoteInfosUsers()}),d.on("receiveUserLeft",function(a){var b=a.replicaNumber;g.emit("removeCollaborator",a),g.removeUser(b),g.updateRemoteInfosUsers()}),d.on("changeCollaboratorCursorAndSelections",function(a){var b=a.replicaNumber,c=a.infosUser.cursorIndex,d=a.infosUser.selections;g.updateCursorAndSelections(b,c,d),g.updateRemoteInfosUsers()}),d.on("changeCollaboratorUsername",function(a){var b=a.replicaNumber,c=a.username;g.updateUsername(b,c),g.updateRemoteInfosUsers()}),d.on("connect",function(){g.offlineMode=!1,g.updateRemoteInfosUsers()}),d.on("disconnect",function(){g.offlineMode=!0,g.emit("updateRemoteIndicators",{infosUsers:{}}),g.emit("updateCollaboratorsList",{infosUsers:{}})})}this.serverDB=f,this.initUsername()};d.prototype.__proto__=c.EventEmitter.prototype,d.prototype.initUsername=function(){var a=this,b=null;this.serverDB.models.query().filter("docID",this.docID).execute().done(function(c){c.length>0&&(b=c[0].username),a.updateLocalUsername(b)})},d.prototype.getLocalInfosUser=function(){return this.infosUsers[this.replicaNumber]},d.prototype.getUsername=function(){return this.infosUsers[this.replicaNumber].username},d.prototype.updateCursorAndSelections=function(a,b,c){null!==this.infosUsers[a]&&void 0!==this.infosUsers[a]&&(this.infosUsers[a].cursorIndex=b,this.infosUsers[a].selections=c)},d.prototype.applyLocalOperation=function(a,b,c){var d,e;for(d in this.infosUsers)if(e=this.infosUsers[d],parseInt(this.replicaNumber)!==parseInt(d))for(b<e.cursorIndex&&("insertText"===a?e.cursorIndex+=c.length:"removeText"===a&&(e.cursorIndex-=c.length)),i=0;i<e.selections.length;i++)selection=e.selections[i],b<selection.start&&("insertText"===a?selection.start+=c.length:"removeText"===a&&(selection.start-=c.length)),b<selection.end&&("insertText"===a?selection.end+=c.length:"removeText"===a&&(selection.end-=c.length))},d.prototype.applyRemoteOperations=function(a){var b,c,d,e,f=0;for(b=0;b<a.length;b++){d=a[b],void 0!==d.content&&void 0!==d.offset&&null!==d.content&&null!==d.offset?f=d.content.length:void 0!==d.length&&null!==d.length&&void 0!==d.offset&&null!==d.offset&&(f=-d.length);for(e in this.infosUsers)if(parseInt(e)!==parseInt(d.owner))for(infosUser=this.infosUsers[e],d.offset<infosUser.cursorIndex&&(infosUser.cursorIndex+=f),c=0;c<infosUser.selections.length;c++)selection=infosUser.selections[c],d.offset<selection.start&&(selection.start+=f),d.offset<selection.end&&(selection.end+=f)}},d.prototype.updateRemoteInfosUsers=function(){var a,b,c=this,d={};null===this.updateTimeout&&(this.updateTimeout=setTimeout(function(){for(a in c.infosUsers)parseInt(a)!==parseInt(c.replicaNumber)&&parseInt(c.replicaNumber)>0&&(b=c.infosUsers[a],d[a]=b);c.readOnlyMode===!1&&c.offlineMode===!1&&c.emit("updateRemoteIndicators",{infosUsers:d}),c.offlineMode===!1&&c.emit("updateCollaboratorsList",{infosUsers:d}),c.updateTimeout=null},100))},d.prototype.addUser=function(a,b){this.infosUsers[a]={username:b,cursorIndex:0,selections:[]}},d.prototype.removeUser=function(a){parseInt(this.replicaNumber)!==parseInt(a)&&delete this.infosUsers[a]},d.prototype.updateLocalUsername=function(a){var b=this;this.serverDB.models.query().filter("docID",this.docID).modify({username:a}).execute().done(function(){b.infosUsers[b.replicaNumber].username=a,b.emit("changeLocalUsername",{replicaNumber:b.replicaNumber,username:a})})},d.prototype.updateUsername=function(a,b){null!==this.infosUsers[a]&&void 0!==this.infosUsers[a]&&(this.infosUsers[a].username=b)},b.exports=d},{events:6}],5:[function(a,b){var c=a("events"),d=function(a){var b=this;this.coordinator=a,this.socket=null,this.connectionCreated=!1,this.infosUsersModule=null,this.coordinator.on("initNetwork",function(){b.toOnlineMode()}),this.coordinator.on("queryDoc",function(a){a.username=b.infosUsersModule.getUsername(),b.socket.emit("joinDoc",a,function(a){a.error===!1&&b.emit("ack",{length:a.length})})})};d.prototype.__proto__=c.EventEmitter.prototype,d.prototype.setInfosUsersModule=function(a){var b=this;this.infosUsersModule=a,a.on("changeLocalCursorAndSelections",function(a){null!==b.socket&&void 0!==b.socket&&b.socket.emit("sendLocalInfosUser",a)}),a.on("changeLocalUsername",function(a){null!==b.socket&&void 0!==b.socket&&b.socket.emit("sendLocalUsername",a)})},d.prototype.createSocket=function(){var a=this,b={"sync disconnect on unload":!0};this.socket=io.connect(location.origin,b),this.socket.on("sendDoc",function(b){a.emit("receiveDoc",b)}),this.socket.on("broadcastOps",function(b){a.emit("receiveOps",b)}),this.socket.on("broadcastCollaboratorCursorAndSelections",function(b){a.emit("changeCollaboratorCursorAndSelections",b)}),this.socket.on("broadcastCollaboratorUsername",function(b){a.emit("changeCollaboratorUsername",b)}),this.socket.on("broadcastParole",function(b){a.emit("receiveParole",b)}),this.coordinator.on("operations",function(b){a.send(b)}),this.coordinator.on("disconnect",function(){a.toOfflineMode()}),this.socket.on("connect",function(){a.emit("connect")}),this.socket.on("disconnect",function(){a.emit("disconnect")}),this.socket.on("userJoin",function(b){a.emit("receiveUserJoin",b)}),this.socket.on("userLeft",function(b){a.emit("receiveUserLeft",b)})},d.prototype.toOnlineMode=function(){null===this.socket?this.createSocket():this.connectionCreated===!1?(this.connectionCreated=!0,this.socket.socket.connect()):this.socket.socket.reconnect()},d.prototype.toOfflineMode=function(){null!==this.socket&&void 0!==this.socket&&this.socket.disconnect()},d.prototype.send=function(a){var b=this,c={logootSOperations:a,lastModificationDate:new Date};this.socket.socket.connected===!0&&this.socket.emit("sendOps",c,function(a){a.error===!1&&b.emit("ack",{length:a.length})})},d.prototype.dispose=function(){this.toOfflineMode(),this.coordinator.removeAllListeners("initNetwork"),this.coordinator.removeAllListeners("queryDoc"),this.coordinator.removeAllListeners("infosUser"),this.coordinator.removeAllListeners("operations"),this.coordinator.removeAllListeners("disconnect"),this.socket.removeAllListeners("connect"),this.socket.removeAllListeners("reconnect"),this.socket.removeAllListeners("disconnect"),this.socket.removeAllListeners("sendDoc"),this.socket.removeAllListeners("broadcastOps"),this.socket.removeAllListeners("sendInfosUsers"),this.socket.removeAllListeners("broadcastParole"),this.socket=null,this.coordinator=null},b.exports=d},{events:6}],6:[function(a,b){function c(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function d(a){return"function"==typeof a}function e(a){return"number"==typeof a}function f(a){return"object"==typeof a&&null!==a}function g(a){return void 0===a}b.exports=c,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._maxListeners=void 0,c.defaultMaxListeners=10,c.prototype.setMaxListeners=function(a){if(!e(a)||0>a||isNaN(a))throw TypeError("n must be a positive number");return this._maxListeners=a,this},c.prototype.emit=function(a){var b,c,e,h,i,j;if(this._events||(this._events={}),"error"===a&&(!this._events.error||f(this._events.error)&&!this._events.error.length))throw b=arguments[1],b instanceof Error?b:TypeError('Uncaught, unspecified "error" event.');if(c=this._events[a],g(c))return!1;if(d(c))switch(arguments.length){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];c.apply(this,h)}else if(f(c)){for(e=arguments.length,h=new Array(e-1),i=1;e>i;i++)h[i-1]=arguments[i];for(j=c.slice(),e=j.length,i=0;e>i;i++)j[i].apply(this,h)}return!0},c.prototype.addListener=function(a,b){var e;if(!d(b))throw TypeError("listener must be a function");if(this._events||(this._events={}),this._events.newListener&&this.emit("newListener",a,d(b.listener)?b.listener:b),this._events[a]?f(this._events[a])?this._events[a].push(b):this._events[a]=[this._events[a],b]:this._events[a]=b,f(this._events[a])&&!this._events[a].warned){var e;e=g(this._maxListeners)?c.defaultMaxListeners:this._maxListeners,e&&e>0&&this._events[a].length>e&&(this._events[a].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[a].length),"function"==typeof console.trace&&console.trace())}return this},c.prototype.on=c.prototype.addListener,c.prototype.once=function(a,b){function c(){this.removeListener(a,c),e||(e=!0,b.apply(this,arguments))}if(!d(b))throw TypeError("listener must be a function");var e=!1;return c.listener=b,this.on(a,c),this},c.prototype.removeListener=function(a,b){var c,e,g,h;if(!d(b))throw TypeError("listener must be a function");if(!this._events||!this._events[a])return this;if(c=this._events[a],g=c.length,e=-1,c===b||d(c.listener)&&c.listener===b)delete this._events[a],this._events.removeListener&&this.emit("removeListener",a,b);else if(f(c)){for(h=g;h-->0;)if(c[h]===b||c[h].listener&&c[h].listener===b){e=h;break}if(0>e)return this;1===c.length?(c.length=0,delete this._events[a]):c.splice(e,1),this._events.removeListener&&this.emit("removeListener",a,b)}return this},c.prototype.removeAllListeners=function(a){var b,c;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[a]&&delete this._events[a],this;if(0===arguments.length){for(b in this._events)"removeListener"!==b&&this.removeAllListeners(b);return this.removeAllListeners("removeListener"),this._events={},this}if(c=this._events[a],d(c))this.removeListener(a,c);else for(;c.length;)this.removeListener(a,c[c.length-1]);return delete this._events[a],this},c.prototype.listeners=function(a){var b;return b=this._events&&this._events[a]?d(this._events[a])?[this._events[a]]:this._events[a].slice():[]},c.listenerCount=function(a,b){var c;return c=a._events&&a._events[b]?d(a._events[b])?1:a._events[b].length:0}},{}],7:[function(a,b){b.exports=a("./lib/index")},{"./lib/index":11}],8:[function(a,b){var c=function(a,b){this.base=a||null,this.last=b||0},d=function(a,b){for(;a.hasNext()&&b.hasNext();){var c=a.next(),d=b.next();if(d>c)return-1;if(c>d)return 1}return a.hasNext()?1:b.hasNext()?-1:0};c.prototype.compareTo=function(a){return null!=a?d(this.iterator(),a.iterator()):void 0},c.prototype.equals=function(a){return this==a?!0:typeof a!=typeof this||null==a?!1:(null!=this.base?this.base.equals(a.base):null==a.base)?(null!=this.last?this.last!=a.last:null!=a.last)?!1:!0:!1},c.prototype.hashCode=function(){var a=null!=this.base?this.base.hashCode():0;return a=31*a+(null!=this.last?this.last:0)},c.prototype.iterator=function(){var a=new Iterator(Utils.iterator(this.base),this.last);return a},c.prototype.toString=function(){return"Identifier{"+this.base+","+this.last+"}"},c.prototype.copy=function(){return new c(Utils.copy(this.base),this.last)},c.prototype.hasPlaceAfter=function(a,b){for(var c=b+this.last,d=Utils.iterator(this.base),e=a.iterator();d.hasNext()&&e.hasNext();)if(d.next()!=e.next())return!1;return e.hasNext?e.next()>=c:!0},c.prototype.hasPlaceBefore=function(a,b){for(var c=this.last-b,d=Utils.iterator(this.base),e=Utils.iterator(a);d.hasNext()&&e.hasNext();)if(d.next()!=e.next())return!0;return e.hasNext()?e.next()<c:!0},c.prototype.minOffsetAfterPrev=function(a,b){for(var c=Utils.iterator(this.base),d=Utils.iterator(a.iterator);c.hasNext()&&d.hasNext();)if(c.next()!=d.next())return b;return d.hasNext()?Math.max(d.next(),b+1):b},c.prototype.maxOffsetBeforeNex=function(a,b){for(var c=Utils.iterator(this.base),d=Utils.iterator(a);c.hasNext()&&d.hasNext();)if(c.next()!=d.next())return b;return d.hasNext()?Math.min(d.next(),b):b},b.exports=c},{}],9:[function(a,b){var c=function(a,b,c){this.base=a||[],this.begin=b||0,this.end=c||0};c.prototype.copy=function(){return new c(Utils.copy(this.base),this.begin,this.end)},c.prototype.getBaseId=function(a){return new Identifier(this.base,a)},c.prototype.addBegin=function(a){this.begin+=a},c.prototype.addEnd=function(a){this.end+=a},c.prototype.getBeginId=function(){return new Identifier(this.base,this.begin)},c.prototype.getEndId=function(){return new Identifier(this.base,this.end)},c.prototype.equals=function(a){return this==a?!0:typeof a!=typeof this?!1:a.begin!=this.begin?!1:a.end!=this.end?!1:(null!=this.base?this.base.equals(a.base):null==a.base)?!0:!1},c.prototype.hashCode=function(){var a=null!=this.base?base.hashCode():0;return a=31*a+this.begin,a=31*a+this.end},c.prototype.toString=function(){return"IdentifierInterval{["+this.base+"],["+this.begin+".."+this.end+"]}"},b.exports=c},{}],10:[function(a,b){b.exports={createBetweenPosition:function(a,b,c,d){for(var e=new InfiniteString(Number.MIN_VALUE,null!=a?a.iterator():null),f=new InfiniteString(Number.MAX_VALUE,null!=b?b.iterator():null),g=[];;){var h=e.next(),i=f.next();if(i-h>2){var j=Math.random()*(i-h-2)+h+1;g.push(j);break}g.push(h)}return g.push(c),g.push(d),g}}},{}],11:[function(a,b){b.exports={Identifier:a("./identifier"),IdentifierInterval:a("./identifierinterval"),IDFactory:a("./idfactory"),InfiniteString:a("./infinitestring"),Iterator:a("./iterator"),IteratorHelperIdentifier:a("./iteratorhelperidentifier"),LogootSAdd:a("./logootsadd"),LogootSBlock:a("./logootsblock"),LogootSDel:a("./logootsdel"),LogootSRopes:a("./logootsropes"),ResponseIntNode:a("./responseintnode"),RopesNodes:a("./ropesnodes"),TextDelete:a("./textdelete"),TextInsert:a("./textinsert")}},{"./identifier":8,"./identifierinterval":9,"./idfactory":10,"./infinitestring":12,"./iterator":13,"./iteratorhelperidentifier":14,"./logootsadd":15,"./logootsblock":16,"./logootsdel":17,"./logootsropes":18,"./responseintnode":19,"./ropesnodes":20,"./textdelete":21,"./textinsert":22}],12:[function(a,b){var c=function(a,b){this.ch=a||null,this.it=b||null};c.prototype.hasNext=function(){return!0},c.prototype.next=function(){return null!=this.it&&this.it.hasNext()?this.it.next():this.ch
},b.exports=c},{}],13:[function(a,b){var c=function(a,b){this.it=a||null,this.more=b||0,this.nexte="a",this.loadNext()};c.prototype.loadNext=function(){this.it.hasNext()?this.nexte=this.it.next():(this.nexte=this.more,this.more=null)},c.prototype.hasNext=function(){return null!=this.nexte},c.prototype.next=function(){var a=this.nexte;return this.loadNext(),a},b.exports=c},{}],14:[function(a,b){var c=function(a,b){this.id1=a,this.id2=b,this.nextOffset=null,this.result=null};c.prototype.compareBase=function(){for(var a=Utils.iterator(this.id1.base),b=Utils.iterator(this.id2.base);a.hasNext()&&b.hasNext();){var c=a.next(),d=b.next();if(c>d)return Utils.Result.B1AfterB2;if(d>c)return Utils.Result.B1BeforeB2}return a.hasNext()?(this.nextOffset=a.next(),this.nextOffset<this.id2.begin?Utils.Result.B1BeforeB2:this.nextOffset>=this.id2.end?Utils.Result.B1AfterB2:Utils.Result.B1InsideB2):b.hasNext()?(this.nextOffset=b.next(),this.nextOffset<this.id1.begin?Utils.Result.B1AfterB2:this.nextOffset>=this.id1.end?Utils.Result.B1BeforeB2:Utils.Result.B2InsideB1):this.id1.end+1==this.id2.begin?Utils.Result.B1ConcatB2:this.id1.begin==this.id2.end+1?Utils.Result.B2ConcatB1:this.id1.end<this.id2.begin?Utils.Result.B1BeforeB2:Utils.Result.B1AfterB2},c.prototype.computeResults=function(){return null==this.result&&(this.result=this.compareBase()),this.result},b.exports=c},{}],15:[function(a,b){var c=function(a,b){this.id=a||null,this.l=b||""};c.prototype.copy=function(){var a=new c;return a.id=this.id.copy(),a.l=this.l,a},c.prototype.execute=function(a){var b={id:this.id,str:this.l};return a.addBlock(b)},b.exports=c},{}],16:[function(a,b){var c=function(a,b){this.id=a||null,this.nbElement=b||0,this.mine=!1};c.prototype.addBlock=function(a,b){this.nbElement+=b,this.id.begin=Math.min(this.id.begin,a),this.id.end=Math.max(this.id.end,a+b-1)},c.prototype.delBlock=function(a,b,c){this.nbElement-=c},c.prototype.copy=function(){return new c(this.id.copy(),this.nbElement)},c.prototype.copyFromJSON=function(a){var b=Utils.copy(a.id.base);this.id=new IdentifierInterval(b,a.begin,a.end)},c.prototype.toString=function(){return"{"+this.nbElement+","+this.id.toString()+", "+(this.mine?"mine":"its")+"}"},b.exports=c},{}],17:[function(a,b){var c=function(a){this.lid=[];for(var b=0;b<a.length;b++){var c=new IdentifierInterval(a[b].base,a[b].begin,a[b].end);this.lid.push(c)}};c.prototype.copy=function(){var a=new c;a.lid=[];for(var b=0;b<this.lid.length;b++)a.lid.push(lid[b].copy());return a},c.prototype.execute=function(a){for(var b=[],c=0;c<this.lid.length;c++)Utils.pushAll(b,a.delBlock(this.lid[c]));return b},b.exports=c},{}],18:[function(a,b){Utils=a("mute-utils"),Identifier=a("./identifier"),IdentifierInterval=a("./identifierinterval"),IDFactory=a("./idfactory"),InfiniteString=a("./infinitestring"),Iterator=a("./iterator"),IteratorHelperIdentifier=a("./iteratorhelperidentifier"),LogootSAdd=a("./logootsadd"),LogootSBlock=a("./logootsblock"),LogootSDel=a("./logootsdel"),ResponseIntNode=a("./responseintnode"),RopesNodes=a("./ropesnodes"),TextDelete=a("./textdelete"),TextInsert=a("./textinsert");var c=function(a){this.replicaNumber=a||0,this.clock=0,this.root=null,this.mapBaseToBlock={},this.str=""};c.prototype.getBlock=function(a){var b=this.mapBaseToBlock[Utils.replaceDots(""+a.base)];return null==b&&(b=new LogootSBlock(a),this.mapBaseToBlock[Utils.replaceDots(""+a.base)]=b),b},c.prototype.addBlock=function(a){if(null!=a.idi&&null!=a.str&&null!=a.from&&null!=a.startOffset){for(var b=a.idi,c=a.str,d=a.from,e=a.startOffset,f=[],g=[],h=[],i=!0,j=e;i;){f.push(d);var k,l=new IteratorHelperIdentifier(b,d.getIdentifierInterval());switch(l.computeResults()){case Utils.Result.B1AfterB2:if(null==d.right){var m={length:c.length,offset:b.begin,block:this.getBlock(b)};d.right=new RopesNodes(m),j=j+d.getSizeNodeAndChildren(0)+d.length,h.push(new TextInsert(j,c)),i=!1}else j=j+d.getSizeNodeAndChildren(0)+d.length,d=d.right;break;case Utils.Result.B1BeforeB2:if(null==d.left){var m={length:c.length,offset:b.begin,block:this.getBlock(b)};d.left=new RopesNodes(m),h.push(new TextInsert(j,c)),i=!1}else d=d.left;break;case Utils.Result.B1InsideB2:k=Math.min(d.maxOffset(),l.nextOffset);var m={length:c.length,offset:b.begin,block:this.getBlock(b)},n=new RopesNodes(m),m={node:n,size:k-d.offset+1};f.push(d.split(m)),j+=d.getSizeNodeAndChildren(0),h.push(new TextInsert(j+k-d.offset+1,c)),i=!1;break;case Utils.Result.B2InsideB1:var o=l.nextOffset,p=c.substr(0,o+1-b.begin),q=new IdentifierInterval(b.base,b.begin,o);if(null==d.left){var m={length:p.length,offset:q.begin,block:this.getBlock(q)};d.left=new RopesNodes(m),h.push(new TextInsert(j,p))}else{var m={idi:q,str:p,from:d.left,startOffset:j};Utils.pushAll(h,this.addBlock(m))}if(p=c.substr(o+1-b.begin,c.length),q=new IdentifierInterval(b.base,o+1,b.end),j=j+d.getSizeNodeAndChildren(0)+d.length,null==d.right){var m={length:p.length,offset:q.begin,block:this.getBlock(q)};d.right=new RopesNodes(m),h.push(new TextInsert(j,p))}else{var m={idi:q,str:p,from:d.right,startOffset:j};Utils.pushAll(h,this.addBlock(m))}i=!1;break;case Utils.Result.B1ConcatB2:if(null==d.left){h.push(new TextInsert(j,c)),d.appendBegin(c.length),this.ascendentUpdate(f,c.length),i=!1;break}g=Utils.copy(f),g.push(d.left),this.getXest(Utils.RopesNodes.RIGHT,g),k=d.getIdBegin().minOffsetAfterPrev(Utils.getLast(g).getIdEnd(),b.begin);var r=c.substr(k-b.begin,c.length);if(d.appendBegin(r.length),h.push(new TextInsert(j+d.getSizeNodeAndChildren(0),r)),this.ascendentUpdate(f,r.length),c=c.substr(0,k-b.begin),b=new IdentifierInterval(b.base,b.begin,k-1),!(b.end>=b.begin)){i=!1;break}d=d.left;break;case Utils.Result.B2ConcatB1:if(null==d.right){j=j+d.getSizeNodeAndChildren(0)+d.length,h.push(new TextInsert(j,c)),d.appendEnd(c.length),this.ascendentUpdate(f,c.length),i=!1;break}g=Utils.copy(f),g.push(d.right),this.getXest(Utils.RopesNodes.LEFT,g),k=d.getIdEnd().maxOffsetBeforeNex(Utils.getLast(g).getIdBegin(),b.end);var r=c.substr(0,k+1-b.begin);if(j=j+d.getSizeNodeAndChildren(0)+d.length,d.appendEnd(r.length),h.push(new TextInsert(j,r)),this.ascendentUpdate(f,r.length),c=c.substr(k+1-b.begin,c.length),b=new IdentifierInterval(b.base,k+1,b.end),!(b.end>=b.begin)){i=!1;break}d=d.right,j+=r.length;break;default:return console.log("Not implemented yet"),-1}}return this.balance(f),h}if(null!=a.id&&null!=a.str){var s=a.id,c=a.str,r=[],b=new IdentifierInterval(s.base,s.last,s.last+c.length-1);if(null==this.root){var t=new LogootSBlock(b);this.mapBaseToBlock[Utils.replaceDots(""+t.id.base)]=t;var m={length:c.length,offset:s.last,block:t};return this.root=new RopesNodes(m),r.push(new TextInsert(0,c)),r}var m={idi:b,str:c,from:this.root,startOffset:0};return this.addBlock(m)}},c.prototype.searchFull=function(a,b,c){return null==a?!1:(c.push(a),0==a.getIdBegin().toCompare(b)||this.searchFull(a.left,b,c)||this.searchFull(a.right,b,c)?!0:(c.pop(),!1))},c.prototype.mkNode=function(a,b,c){var d=IDFactory.createBetweenPosition(a,b,this.replicaNumber,this.clock++),e=new IdentifierInterval(d,0,c-1),f=new LogootSBlock(e);this.mapBaseToBlock[Utils.replaceDots(""+e.base)]=f;var g={length:c,offset:0,block:f};return new RopesNodes(g)},c.prototype.insertLocal=function(a,b){if(null==this.root)return this.root=this.mkNode(null,null,b.length),this.root.block.mine=!0,this.str=Utils.insert(this.str,a,b),new LogootSAdd(this.root.getIdBegin(),b);var c,d=this.viewLength();this.str=Utils.insert(this.str,a,b);var e;if(0==a){e=[],e.push(this.root);var f={i:Utils.RopesNodes.LEFT,path:e},g=this.getXest(f);if(g.isAppendableBefore()){var h=g.appendBegin(b.length);return this.ascendentUpdate(e,b.length),new LogootSAdd(h,b)}c=this.mkNode(null,g.getIdBegin(),b.length),c.block.mine=!0,g.left=c}else if(a>=d){e=[],e.push(this.root);var f={i:Utils.RopesNodes.RIGHT,path:e},g=this.getXest(f);if(g.isAppendableAfter()){var h=g.appendEnd(b.length);return this.ascendentUpdate(e,b.length),new LogootSAdd(h,b)}c=this.mkNode(g.getIdEnd(),null,b.length),c.block.mine=!0,g.right=c}else{var f={pos:a},i=this.search(f);if(i.i>0){var j=i.node.block.id.getBaseId(i.node.offset+i.i-1),k=i.node.block.id.getBaseId(i.node.offset+i.i);c=this.mkNode(j,k,b.length),c.block.mine=!0,e=i.path;var f={size:i.i,node:c};e.push(i.node.split(f))}else{var f={pos:a-1},l=this.search(f);if(i.node.isAppendableBefore()&&i.node.getIdBegin().hasPlaceBefore(l.node.getIdEnd(),b.length)){var h=i.node.appendBegin(b.length);return this.ascendentUpdate(i.path,b.length),new LogootSAdd(h,b)}if(l.node.isAppendableAfter()&&l.node.getIdEnd().hasPlaceAfter(i.node.getIdBegin(),b.length)){var h=l.node.appendEnd(b.length);return this.ascendentUpdate(l.path,b.length),new LogootSAdd(h,b)}c=this.mkNode(l.node.getIdEnd(),i.node.getIdBegin(),b.length),c.block.mine=!0,c.right=l.node.right,l.node.right=c,e=l.path,e.push(c)}}return this.balance(e),new LogootSAdd(c.getIdBegin(),b)},c.prototype.getXest=function(a){if(null!=a.i&&null!=a.n){for(var b=a.i,c=a.n;null!=c.getChild(b);)c=c.getChild(b);return c}if(null!=a.i&&null!=a.path){for(var b=a.i,d=a.path,c=d[d.length-1];null!=c.getChild(b);)c=c.getChild(b),d.push(c);return c}},c.prototype.search=function(a){if(null!=a.id&&null!=a.path){for(var b=a.id,c=a.path,d=0,e=this.root;null!=e;)if(c.push(e),b.compareTo(e.getIdBegin())<0)e=e.left;else{if(!(b.compareTo(e.getIdEnd())>0))return d+=e.getSizeNodeAndChildren(0);d=d+e.getSizeNodeAndChildren(0)+e.length,e=e.right}return-1}if(null!=a.pos){for(var f=a.pos,e=this.root,c=[];null!=e;){c.push(e);var g=null==e.left?0:e.left.sizeNodeAndChildren;if(g>f)e=e.left;else{if(f<g+e.length)return new ResponseIntNode(f-g,e,c);f-=g+e.length,e=e.right}}return null}},c.prototype.ascendentUpdate=function(a,b){for(var c=a.length-1;c>=0;c--)a[c].addString(b)},c.prototype.delBlock=function(a){for(var b,c=[];;){var d=[],e={id:a.getBeginId(),path:d};if(-1==(b=this.search(e))){if(!(a.begin<a.end))return c;a=new IdentifierInterval(a.base,a.begin+1,a.end)}else{var f=Utils.getLast(d),g=Math.min(a.end,f.maxOffset()),h=b+a.begin-f.offset,i=g-a.begin+1;c.push(new TextDelete(h,i));var j=f.deleteOffsets(a.begin,g);if(0==f.length?this.delNode(d):null!=j?(d.push(j),this.balance(d)):this.ascendentUpdate(d,a.begin-g-1),g==a.end)break;a=new IdentifierInterval(a.base,g,a.end)}}return c},c.prototype.delLocal=function(a,b){this.str=Utils.del(this.str,a,b);var c=b-a+1,d=[];do{var e={pos:a},f=this.search(e);if(null!=f){var g=f.node.offset+f.i,h=Math.min(g+c-1,f.node.maxOffset());d.push(new IdentifierInterval(f.node.block.id.base,g,h));var i=f.node.deleteOffsets(g,h);c-=h-g+1,0==f.node.length?this.delNode(f.path):null!=i?(f.path.push(i),this.balance(f.path)):this.ascendentUpdate(f.path,g-h-1)}else c=0}while(c>0);return new LogootSDel(d)},c.prototype.delNode=function(a){var b=Utils.getLast(a);if(0==b.block.nbElement&&(this.mapBaseToBlock[Utils.replaceDots(""+b.block.id.base)]=null),null==b.right)b==this.root?this.root=b.left:(a.pop(),Utils.getLast(a).replaceChildren(b,b.left));else if(null==b.left)b==this.root?this.root=b.right:(a.pop(),Utils.getLast(a).replaceChildren(b,b.right));else{a.push(b.right);var c=this.getMinPath(a);b.become(c),a.pop(),Utils.getLast(a).replaceChildren(c,c.right)}this.balance(a)},c.prototype.getMinPath=function(a){var b=Utils.getLast(a);if(null==b)return null;for(;null!=b.left;)b=b.left,a.push(b);return b},c.prototype.getLeftest=function(a){if(null==a)return null;for(;null!=a.left;)a=a.left;return a},c.prototype.getMinId=function(a){var b=this.getLeftest(a);return null!=b?b.getIdBegin():null},c.prototype.balance=function(a){for(var b=0==a.length?null:a.pop(),c=0==a.length?null:Utils.getLast(a);null!=b;){b.sumDirectChildren();for(var d=b.balanceScore();Math.abs(d)>=2;)c=d>=2?null!=b.right&&b.right.balanceScore()<=-1?this.rotateRL(b,c):this.rotateLeft(b,c):null!=b.left&&b.left.balanceScore()>=1?this.rotateLR(b,c):this.rotateRight(b,c),a.push(c),d=b.balanceScore();b=0==a.length?null:a.pop(),c=0==a.length?null:Utils.getLast(a)}},c.prototype.rotateLeft=function(a,b){var c=a.right;return a==this.root?this.root=c:b.replaceChildren(a,c),a.right=c.left,c.left=a,a.sumDirectChildren(),c.sumDirectChildren(),c},c.prototype.rotateRight=function(a,b){var c=a.left;return a==this.root?this.root=c:b.replaceChildren(a,c),a.left=c.right,c.right=a,a.sumDirectChildren(),c.sumDirectChildren(),c},c.prototype.rotateRL=function(a,b){return this.rotateRight(a.right,a),this.rotateLeft(a,b)},c.prototype.rotateLR=function(a,b){return this.rotateLeft(a.left,a),this.rotateRight(a,b)},c.prototype.getNext=function(a){var b=Utils.getLast(a);if(null==b.right){if(a.length>1){var c=a.get(a.length-2);if(c.left==b)return a.pop(),!0}return!1}a.push(b.right);var d={i:Children.LEFT,path:a};return this.getXest(d),!0},c.prototype.duplicate=function(a){var b=this.copy();return b.replicaNumber=a,b.clock=0,b},c.prototype.copy=function(){var a=new c(this.replicaNumber);a.str=this.str,a.clock=this.clock,a.root=null!=this.root?this.root.copy():null,a.mapBaseToBlock={};for(var b in this.mapBaseToBlock)a.mapBaseToBlock[b]=this.mapBaseToBlock[b];return a},c.prototype.copyFromJSON=function(a){var b;this.str=a.str;for(b in a.mapBaseToBlock)this.mapBaseToBlock[b]=a.mapBaseToBlock[b];if(null!==a.root&&void 0!==a.root){var c=a.root,d={block:null,offset:c.offset,length:c.length};this.root=new RopesNodes(d),this.root.copyFromJSON(c)}},c.prototype.view=function(){return this.str},c.prototype.viewLength=function(){return this.str.length},b.exports=c},{"./identifier":8,"./identifierinterval":9,"./idfactory":10,"./infinitestring":12,"./iterator":13,"./iteratorhelperidentifier":14,"./logootsadd":15,"./logootsblock":16,"./logootsdel":17,"./responseintnode":19,"./ropesnodes":20,"./textdelete":21,"./textinsert":22,"mute-utils":23}],19:[function(a,b){var c=function(a,b,c){this.i=a||0,this.node=b||null,this.path=c||null};b.exports=c},{}],20:[function(a,b){var c=function(a){this.block=a.block||null,this.offset=a.offset||0,this.length=a.length||0,this.sizeNodeAndChildren=this.length,this.left=null,this.right=null,this.height=1;var b=a.newer;if(null==b&&(b=!0),b&&null!=this.block)try{this.block.addBlock(this.offset,this.length)}catch(c){console.error("---- Exception dans new RopesNodes lors d'addBlock ----"),console.error("Args : ",a),console.error("Newer : ",b),console.error("This : ",this)}};c.prototype.getIdBegin=function(){return this.block.id.getBaseId(this.offset)},c.prototype.getIdEnd=function(){return this.block.id.getBaseId(this.offset+this.length-1)},c.prototype.copy=function(){var a={block:null!==this.block?this.block.copy():null,offset:this.offset,length:this.length},b=new c(a);return b.height=this.height,b.left=null!=this.left?this.left.copy():null,b.right=null!=this.right?this.right.copy():null,b},c.prototype.addString=function(a){this.sizeNodeAndChildren+=a},c.prototype.getChild=function(a){return a==Utils.RopesNodes.RIGHT?this.right:a==Utils.RopesNodes.LEFT?this.left:void 0},c.prototype.appendEnd=function(a){var b=this.maxOffset()+1;return this.length+=a,this.block.addBlock(b,a),this.block.id.getBaseId(b)},c.prototype.appendBegin=function(a){return this.offset-=a,this.length+=a,this.block.addBlock(this.offset,a),this.getIdBegin()},c.prototype.deleteOffsets=function(a,b){var c=b-a+1;if(this.block.delBlock(a,b,c),c==this.length)return this.length=0,null;var d=null;if(b==this.offset+this.length-1)this.length=a-this.offset;else if(a==this.offset)this.length=this.length-b+this.offset-1,this.offset=b+1;else{var e={size:b-this.offset+1};d=this.split(e),this.length=a-this.offset}return d},c.prototype.split=function(a){if(null!=a.node&&null!=a.size){var b=a.node,d=a.size;this.height++;var e={size:d},f=this.split(e);return f.left=b,f.height++,f}if(null!=a.size){var d=a.size;this.height++;var e={length:this.length-d,offset:this.offset+d,block:this.block,newer:!1},f=new c(e);return this.length=d,null!=this.right&&(f.right=this.right,f.height+=f.right.height+1,f.sizeNodeAndChildren+=f.right.sizeNodeAndChildren),this.right=f,f}},c.prototype.maxOffset=function(){return this.offset+this.length-1},c.prototype.sumDirectChildren=function(){this.height=Math.max(this.getSubtreeHeight(Utils.RopesNodes.LEFT),this.getSubtreeHeight(Utils.RopesNodes.RIGHT))+1,this.sizeNodeAndChildren=this.getSizeNodeAndChildren(Utils.RopesNodes.LEFT)+this.getSizeNodeAndChildren(Utils.RopesNodes.RIGHT)+this.length},c.prototype.getSubtreeHeight=function(a){var b=this.getChild(a);return null==b?0:b.height},c.prototype.getSizeNodeAndChildren=function(a){var b=this.getChild(a);return null==b?0:b.sizeNodeAndChildren},c.prototype.replaceChildren=function(a,b){this.left==a?this.left=b:this.right==a&&(this.right=b)},c.prototype.balanceScore=function(){return this.getSubtreeHeight(Utils.RopesNodes.RIGHT)-this.getSubtreeHeight(Utils.RopesNodes.LEFT)},c.prototype.become=function(a){this.sizeNodeAndChildren=-this.length+a.length,this.length=a.length,this.offset=a.offset,this.block=a.block},c.prototype.isAppendableAfter=function(){return this.block.mine&&this.block.id.end==this.maxOffset()},c.prototype.isAppendableBefore=function(){return this.block.mine&&this.block.id.begin==this.offset},c.prototype.toString=function(){return new IdentifierInterval(this.block.id.base,this.offset,this.maxOffset()).toString()+","},c.prototype.viewRec=function(){var a="";return(null!=this.left||null!=this.right)&&(a+="( "),null!=this.left&&(a+=this.left.viewRec()),(null!=this.left||null!=this.right)&&(a+=" //,// "),a+=this.str,(null!=this.left||null!=this.right)&&(a+=" \\\\,\\\\ "),null!=this.right&&(a+=this.right.viewRec()),(null!=this.left||null!=this.right)&&(a+=" )"),a},c.prototype.getIdentifierInterval=function(){return new IdentifierInterval(this.block.id.base,this.offset,this.offset+this.length-1)},c.prototype.copyFromJSON=function(a){if(this.height=a.height,this.sizeNodeAndChildren=a.sizeNodeAndChildren,null!==a.block&&void 0!==a.block&&(this.block=new LogootSBlock(null,a.block.nbElement),this.block.copyFromJSON(a.block)),null!==a.left&&void 0!==a.left){var b={block:null,offset:a.left.offset,length:a.left.length};this.left=new c(b),this.left.copyFromJSON(a.left)}if(null!==a.right&&void 0!==a.right){var b={block:null,offset:a.right.offset,length:a.right.length};this.right=new c(b),this.right.copyFromJSON(a.right)}},b.exports=c},{}],21:[function(a,b){var c=function(a,b){this.offset=a||0,this.length=b||0};c.prototype.applyTo=function(a){return a.delLocal(this.offset,this.offset+this.length-1)},b.exports=c},{}],22:[function(a,b){var c=function(a,b){this.offset=a||0,this.content=b||null};c.prototype.applyTo=function(a){return a.insertLocal(this.offset,this.content)},b.exports=c},{}],23:[function(a,b){b.exports={Result:{B1AfterB2:"B1AfterB2",B1BeforeB2:"B1BeforeB2",B1InsideB2:"B1InsideB2",B2InsideB1:"B2InsideB1",B1ConcatB2:"B1ConcatB2",B2ConcatB1:"B2ConcatB1"},RopesNodes:{LEFT:0,RIGHT:1},insert:function(a,b,c){return b>0?a.substring(0,b)+c+a.substring(b,a.length):c+a},del:function(a,b,c){var d="";return 0!==b&&(d=a.substring(0,b)),d+a.substring(c+1,a.length)},unset:function(a,b){var c=a.indexOf(b);c>-1&&a.splice(c,1)},pushAll:function(a,b){var c;for(c=0;c<b.length;c++)a.push(b[c])},iterator:function(a){var b={index:0,items:a,first:function(){return this.reset(),this.next()},next:function(){return this.items[this.index++]},hasNext:function(){return this.index<this.items.length},reset:function(){this.index=0}};return b},getLast:function(a){return a[a.length-1]},copy:function(a){var b,c=[];for(b=0;b<a.length;b++)c.push("number"==typeof a[b]||"string"==typeof a[b]?a[b]:null!==a[b]&&void 0!==a[b]&&null!==a[b].copy&&void 0!==a[b].copy?a[b].copy():a[b]);return c},occurrences:function(a,b,c){var d,e,f;if(a+="",b+="",b.length<=0)return a.length+1;for(d=0,e=0,f=c?1:b.length;;){if(e=a.indexOf(b,e),!(e>=0))break;d++,e+=f}return d},replaceDots:function(a){var b="\\.",c=new RegExp(b,"g");return a.replace(c,"U+FF0E")}}},{}]},{},[1])(1)});